<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<title>周报详情</title>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css">
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="css/app.css" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css" />
		<script src="js/mui.min.js"></script>
		<script src="js/myApp.js"></script>
		<script src="js/mui.picker.min.js "></script>
		<script>
			mui.init({
				swipeBack: false
			});
		</script>
		<style>
			.mui-control-content {
				background-color: white;
				min-height: 300px;
			}
			
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
		</style>
		<style>
			/*跨webview需要手动指定位置*/
			
			#peopleSelPopover {
				height: 300px;
			}
			
			.des {
				margin: .5em 0;
			}
			
			.des>li {
				font-size: 14px;
				color: #8f8f94;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="moreAction" href="#picture" class="mui-icon mui-icon-arrowdown mui-pull-right" style="font-size:17px; margin-top: 6px;">操作</a>
			
			<h1 class="mui-title">周报详情</h1>
		</header>

		<div class="mui-content">
			<!--默认显示为登录人员姓名-->
			<a id="employeeName" href="#peopleSelPopover" class="mui-btn mui-btn-primary mui-btn-outlined" style="margin-left: 5px;margin-top: 2px; padding: 5px ;width: 48%;height: 100%;">毕博阳 ID:136586</a>
			<!--<a id="employeeName" href="#peopleSelPopover" class="mui-btn mui-btn-primary mui-btn-outlined" style="margin-left: 5px;margin-top: 2px; padding: 5px ;width: 48%;height: 100%;">何世菡 ID:065443</a>-->
			<!--<a id="employeeName" href="#peopleSelPopover" class="mui-btn mui-btn-primary mui-btn-outlined" style="margin-left: 5px;margin-top: 2px; padding: 5px ;width: 48%;height: 100%;">腾超 ID:136641</a>-->
			<!--<a id="employeeName" href="#peopleSelPopover" class="mui-btn mui-btn-primary mui-btn-outlined" style="margin-left: 5px;margin-top: 2px; padding: 5px ;width: 48%;height: 100%;">辛浩 ID:100000</a>-->
			<!--<a id="employeeName" href="#peopleSelPopover" class="mui-btn mui-btn-primary mui-btn-outlined" style="margin-left: 5px;margin-top: 2px; padding: 5px ;width: 48%;height: 100%;">高阳 ID:136183</a>-->
			<button id='selectDate' data-options='{"type":"date","beginYear":2014,"endYear":2016}' class="mui-btn mui-btn-primary mui-btn-outlined" style="padding: 5px ;margin-top: 2px;width: 48%;height: 100%;">选择日期</button>

			<div id="slider" class="mui-slider">

				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="#thisweekpredict">
						本周预计
					</a>
					<a class="mui-control-item" href="#beforeweekactual">
						上周实际
					</a>
				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
				<!--Mon. Tues, Wed, Thurs, Fri Sat, Sun-->
				<div class="mui-slider-group">

					<div id="thisweekpredict" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期日<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="sunlistthis">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期一<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view mui-table-view-chevron" id="monlistthis">
												<!--本周预计任务...-->
											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期二<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="tueslistthis">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期三<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="wedlistthis">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期四<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="thurslistthis">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期五<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="frilistthis">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期六<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="satlistthis">

											</ul>
										</div>
									</li>

								</ul>
							</div>
						</div>
					</div>
					<div id="beforeweekactual" class="mui-slider-item mui-control-content " style="font-size: 14px;">

						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期日<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="sunlist">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期一<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="monlist">
												<!--上周实际进展...-->
											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期二<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>							
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="tueslist">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期三<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="wedlist">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期四<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="thurslist">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期五<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="frilist">

											</ul>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">星期六<span class="mui-icon mui-icon-flag" style="display: none;"></span></a>
										<div class="mui-collapse-content">
											<ul class="mui-table-view" id="satlist">

											</ul>
										</div>
									</li>

								</ul>
							</div>
						</div>

					</div>
				</div>

			</div>
			<h4 style="margin: 5px; text-align: center;">特别说明事项</h4>
			<div id="annList">

			</div>
		</div>

		<div id="peopleSelPopover" class="mui-popover">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view" id="employeeList">

					</ul>
				</div>
			</div>

		</div>
		<!--
        	作者：254617749@qq.com
        	时间：2016-07-21
        	描述：H5 Actionsheet
        	保存周报 更新周报 添加特别说明事例 
        -->
		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a id="saveReport" href="#">提交周报</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="updateReport" href="#">保存/更新周报</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="addAnns" href="#">添加特别说明事例</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="editAnns" href="#">编辑特别说明事例</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<script>
			var editMode = 0; //初始非编辑状态
			var today = myApp.get_Today();
			var arrDate = myApp.getMondayOfTheWeekByDate(today);
			var dMon = arrDate[0];
			var dSun = arrDate[1];
			localStorage.thisWeek = dMon.getFullYear() + '-' + (dMon.getMonth() + 1) + '-' + dMon.getDate() + '至' + dSun.getFullYear() + '-' + (dSun.getMonth() + 1) + '-' + dSun.getDate();

			//获取上周
			var pDate = new Date();
			pDate.setDate(pDate.getDate() - 7);
			var pDateStr = pDate.getFullYear() + '-' + (pDate.getMonth() + 1) + '-' + pDate.getDate();
			var arrPDate = myApp.getMondayOfTheWeekByDate(pDateStr);
			var dPMon = arrPDate[0];
			var dPSun = arrPDate[1];
			localStorage.pWeek = dPMon.getFullYear() + '-' + (dPMon.getMonth() + 1) + '-' + dPMon.getDate() + '至' + dPSun.getFullYear() + '-' + (dPSun.getMonth() + 1) + '-' + dPSun.getDate();
			//console.log(localStorage.thisWeek);
			//console.log(localStorage.pWeek);

//初始显示本周,请求本周周报
			document.getElementById("selectDate").innerText = dMon.getFullYear() + '-' + (dMon.getMonth() + 1) + '-' + dMon.getDate() + '至' + dSun.getFullYear() + '-' + (dSun.getMonth() + 1) + '-' + dSun.getDate();
			var reportbody = "\"{'ParaList':[{'Date':'" + today + "','UserID':'" + myApp.userID + "','Refresh':'0'} ], 'FunName': 'GetWeeklyReportDetail'}\"";
			myApp.XMLpostRequest(url, reportbody, myApp.reportOfWeekHandle);

			(function($) {
				$('.mui-scroll-wrapper').scroll({
					indicators: true //是否显示滚动条
				});
				var btn = $('#selectDate')[0];
				var curY = new Date().getFullYear();
				var attrStr = '{"type":"date","beginYear":' + (curY - 1) + ',"endYear": ' + (curY + 1) + '}';
				document.getElementById("selectDate").setAttribute('data-options', attrStr);
				btn.addEventListener('tap', function() {
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var id = this.getAttribute('id');
					/*
					 * 首次显示时实例化组件
					 * 示例为了简洁，将 options 放在了按钮的 dom 上
					 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
					 */
					var picker = new $.DtPicker(options);
					picker.show(function(rs) {
						/*
						 * rs.value 拼合后的 value
						 * rs.text 拼合后的 text
						 * rs.y 年，可以通过 rs.y.vaue 和 rs.y.text 获取值和文本
						 * rs.m 月，用法同年
						 * rs.d 日，用法同年
						 * rs.h 时，用法同年
						 * rs.i 分（minutes 的第二个字母），用法同年
						 */
						var arrDate = myApp.getMondayOfTheWeekByDate(rs.text);
						var dMon = arrDate[0];
						var dSun = arrDate[1];
						btn.innerText = dMon.getFullYear() + '-' + (dMon.getMonth() + 1) + '-' + dMon.getDate() + '至' + dSun.getFullYear() + '-' + (dSun.getMonth() + 1) + '-' + dSun.getDate();
						/* 
						 * 返回 false 可以阻止选择框的关闭
						 * return false;
						 */
						/*
						 * 释放组件资源，释放后将不需要示放组件将不能再操作组件
						 * 通常情况下，，new DtPicker(options) 后，可以一直使用。
						 * 当前示例，因为内容较多，如不进行资原释放，在某些设备上会较慢。
						 * 所以每次用完便立即调用 dispose 进行释放，下次用时再创建新实例。
						 */
						
						//刷新周报(重新请求)
						myApp.requestReportAgain();
						picker.dispose();
					});
				}, false);

			})(mui);

			mui('.mui-scroll-wrapper').scroll();
			mui('body').on('shown', '#peopleSelPopover', function(e) {
				console.log(e.detail.id);//detail为当前popover元素
			});
			//当popover隐藏时触发
			mui('body').on('hidden', '#peopleSelPopover', function(e) {
				//console.log(e.detail.id);//detail为当前popover元素
			//刷新周报(重新请求)
			myApp.requestReportAgain();

			});
			//H5 actionnsheet
			mui('body').on('tap', '.mui-popover-action li>a', function() {
				//测试
				var a = this,
					parent;
				//根据点击按钮，反推当前是哪个actionsheet
				for(parent = a.parentNode; parent != document.body; parent = parent.parentNode) {
					//classList 返回dom元素的class名,数组
					if(parent.classList.contains('mui-popover-action')) {
						break;
					}
				}
				//关闭actionsheet
				mui('#' + parent.id).popover('toggle');
//提交周报
				if(this.id == 'saveReport') {
//					console.log(document.getElementById("selectDate").innerText);
//					console.log(localStorage.thisWeek);
//					console.log(document.getElementById("selectDate").innerText == localStorage.thisWeek);
					if(document.getElementById("selectDate").innerText == localStorage.thisWeek) {// 选的是这周
						if(localStorage.thisWeekFlag == 0) {//如果未提交过
							console.log("提交周报");
							var user = mui('#employeeName')[0].innerText
							if(user.substring(user.length - 6) == myApp.userID) {
								//获得特殊实例方法
								var annStr = getAnnsListBody();

								var reportbody = "\"{'ParaList':[{'Date':'" + localStorage.thisWeek.split('至')[0] + "','UserID':'" + myApp.userID + "','Description':'desc1','Announcements':[" + annStr + "]}],'FunName':'WeeklyReportAdd'}\"";
								myApp.XMLpostRequestSaveReport(url, reportbody,myApp.requestReportAgain);
								
								localStorage.thisWeekFlag = 1;
								//保存后退出编辑模式
								editOff();
							} else {
								mui.toast("只能提交本人的周报");
							}
							
//如果已经提交过
						} else {
							mui.toast("本周(" + localStorage.thisWeek + ")已提交过周报!");
						}

					} else if(document.getElementById("selectDate").innerText == localStorage.pWeek) {// 选的是上周
												if(localStorage.pWeekFlag == 0) {//如果未提交过
							console.log("提交周报");
							var user = mui('#employeeName')[0].innerText
							if(user.substring(user.length - 6) == myApp.userID) {
								//获得特殊实例方法
								var annStr = getAnnsListBody();

								var reportbody = "\"{'ParaList':[{'Date':'" + localStorage.pWeek.split('至')[0] + "','UserID':'" + myApp.userID + "','Description':'desc1','Announcements':[" + annStr + "]}],'FunName':'WeeklyReportAdd'}\"";
								myApp.XMLpostRequestSaveReport(url, reportbody,myApp.requestReportAgain);
								//提交后退出编辑模式				
								localStorage.pWeekFlag = 1;
								editOff();
							} else {
								mui.toast("只能提交本人的周报");
							}
							
//如果已经提交过
						} else {
							mui.toast("上周(" + localStorage.pWeek + ")已提交过周报!");
						}
						
					} else {
						mui.toast("您只能选择最近两周的周报进行提交!")
					}

					//保存/更新周报
				} else if(this.id == 'updateReport') {
					//console.log("保存/更新周报");
					var user = mui('#employeeName')[0].innerText;
					//console.log(user.substring(user.length - 6));
					if(user.substring(user.length - 6) == myApp.userID) {
						if(myApp.reportTempID == undefined){
					mui.alert('您当前所选周尚未提交周报,请先提交!','系统提醒');
				}else{
						//获得特殊事例方法
						var annStr = getAnnsListBody();
					//console.log(myApp.reportTempID);
						//{'ANN_DETAIL':'detail_1'},{'ANN_DETAIL':'detail_2'}   {'ANN_DETAIL':'  +   '},{'ANN_DETAIL':' + .... +  '},{'ANN_DETAIL':' +    '}
						var reportbody = "\"{'ParaList':[{'ReportID':'" + myApp.reportTempID + "','Date':'" + document.getElementById("selectDate").innerText.split('至')[0] + "','UserID':'" + myApp.userID + "','Description':'desc1','Announcements':[" + annStr + "]}],'FunName':'WeeklyReportUpdate'}\"";
						myApp.XMLpostRequestSaveReport(url, reportbody,myApp.requestReportAgain);

						//更新后退出编辑模式
						editOff(); 
				}
					} else {
						mui.toast("只能更新本人的周报");
					}

					//添加特殊事例
				} else if(this.id == 'addAnns') {
					var user = mui('#employeeName')[0].innerText
					if(user.substring(user.length - 6) == myApp.userID) {
						console.log("添加特别说明事例");
						var btnArrayDig = ['取消', '确定'];
						mui.prompt('请输入：', '特别说明事项需要记载：（1）工作计划调整原因等；（2）需要与上级沟通的事项等；（3）其他需要汇报的事宜', '添加特别说明事例', btnArrayDig, function(i) {
							if(i.index == 1) {
								//mui.toast(i.value);
								//添加实例

								var annList = document.getElementById('annList');

								//如果之前没有事例,会有P标签的提示,先删掉
								if(annList.firstChild.tagName == 'P') {
									//console.log(annList.firstChild.tagName);
									//console.log("删节点了啊!!!!!!!!!!!!!!!!");
									annList.removeChild(annList.firstChild);
								}
								var annHead = document.createElement('h5');
								var annTextarea = document.createElement('textarea');
								if(editMode == 0) { //非编辑状态
									annHead.innerHTML = '事项' + (annList.childNodes.length / 2 + 1) + ':' + '<button type="button" class="mui-btn mui-btn-gray deleteAnnsBtn" style="display:none; float:right;">删除</button>';
								} else if(editMode == 1) { //编辑状态
									annHead.innerHTML = '事项' + (annList.childNodes.length / 2 + 1) + ':' + '<button type="button" class="mui-btn mui-btn-gray deleteAnnsBtn" style="float:right;">删除</button>';

								}

								annTextarea.innerText = i.value;
								annTextarea.id = (annHead.innerText + 1) + 'Ann';
								//console.log(annTextarea.id);
								annTextarea.setAttribute('readonly', 'readonly');
								annList.appendChild(annHead);
								annList.appendChild(annTextarea);
								deleteSpecialEvent();
							} else if(i.index == 0) {
								mui.toast('取消添加事例!');
							}
						})
					} else {
						mui.toast("只能修改本人的周报");
					}
					//编辑特殊事例
				} else if(this.id == 'editAnns') {
					var user = mui('#employeeName')[0].innerText
					if(user.substring(user.length - 6) == myApp.userID) {
					var annList = document.getElementById('annList');
					//如果没有事例
					if(annList.firstChild.tagName == 'P') {
						mui.toast('您暂时没有特别说明事项,请先添加!');
						return;
					} else {
						if(this.innerText == '编辑特别说明事例') {
							this.innerText = '关闭编辑状态';

							editOn();
						} else if(this.innerText == '关闭编辑状态') {

							editOff();
						}

					}
					} else {
						mui.toast("只能编辑本人的周报");
					}

				}

			})
			var editOn = function() {
				if(editMode == 1) {
					return;
				}
				editMode = 1;
				mui.toast('进入编辑状态,编辑后注意保存/更新周报!');
				mui('textarea').each(function() {
					this.removeAttribute('readonly');
				});
				mui('.deleteAnnsBtn').each(function() {
					this.style.display = '';
				});
			};
			var editOff = function() {
				if(editMode == 0) {
					return;
				}
				editMode = 0;
				document.getElementById("editAnns").innerText = '编辑特别说明事例';
				mui.toast('已关闭编辑状态!');
				mui('textarea').each(function() {
					this.setAttribute('readonly', 'readonly');
				});
				mui('.deleteAnnsBtn').each(function() {
					this.style.display = 'none';
				});
			};

			var getAnnsListBody = function() {
				//放待录数组
				var annCount = mui('#annList textarea').length;
				var str = new Array(annCount);
				//console.log(annCount);
				mui('#annList textarea').each(function(indexAnn, elem) {
					//所有事例内容存到数组str
					str[indexAnn] = this.innerHTML;
					//console.log(this.innerText);
					//console.log(this.innerHTML);
					console.log(str[indexAnn]);

				});
				var strHead = "{'ANN_DETAIL':'";
				var strCen = "'},{'ANN_DETAIL':'";
				var strFoot = "'}";
				var annStr = '';
				if(str.length == 1) {
					annStr = "{'ANN_DETAIL':'" + str[0] + "'}";
					return annStr;
				} else {
					for(var i = 0; i < str.length; i++) {
						if(i == 0) {
							annStr += strHead;
							annStr += str[i];
							console.log(annStr);
						} else if(i == str.length - 1) {
							annStr += strCen;
							annStr += str[i];
							annStr += strFoot;
							console.log(annStr);
						} else {
							annStr += strCen;
							annStr += str[i];
							console.log(annStr);
						}

					}
					console.log(annStr);
					return annStr;
				}
			}

			//删除特别事项
			var deleteSpecialEvent = function() {
				console.log("进入删除特别事例方法!");
						//为每个删除事例按钮添加手势
		mui('h5').on('tap', '.deleteAnnsBtn', function() {
			console.log("删除事例按钮添加手势");		
			//console.log(this.parentNode);
			//		console.log(this.previousSibling.value);
			//  console.log(this.parentNode.nextSibling);
			var tapBtn = this;
			var annTitle = this.parentNode.innerText;
			var btnArray = ['否', '是'];
			mui.confirm('确认将' + annTitle + '？', '系统提示', btnArray, function(e) {
				if(e.index == 1) {
					//console.log('是');
					console.log(tapBtn.parentNode);
					console.log(tapBtn.parentNode.nextSibling);
					var annList = document.getElementById('annList');
					annList.removeChild(tapBtn.parentNode.nextSibling)
					annList.removeChild(tapBtn.parentNode);
					mui.toast('删除事例成功!')
					if(annList.childNodes.length == 0) {
						mui.toast('已没特别事项可编辑,关闭编辑状态.')
						annList.innerHTML = '<p style="color:gray"><span style="font-size:16px;">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp无特别事项!如需添加请在右上角<操作>中添加特别说明事项,添加后记得保存/更新周报!</span></p>';
						editOff();
					}

				} else {
					mui.toast('取消删除');
					//console.log(this.innerHTML);
				}
			}, 'div');

		});
			}
		</script>

	</body>

</html>